<script>
  flatpickr("#date", {
    minDate: "today",
    dateFormat: "Y-m-d",
    onChange: async function(selectedDates, dateStr) {
      await generateSlots(dateStr);
    }
  });


  const AIRTABLE_API_KEY = "patinzdAtVnSptMDq.7f767ff0ed465c36042c7708c5c205164a7d53d21aeb2267efb4f7411e503826";
  const AIRTABLE_BASE_ID = "appePVNt5JXGHbCPm";
  const AIRTABLE_TABLE_NAME = "Appointments";
  const sid = new URLSearchParams(window.location.search).get("sid") || "test123";

  const slotContainer = document.getElementById("slots");
  let selectedSlot = null;

  async function generateSlots(date = "") {
    slotContainer.innerHTML = "";
    selectedSlot = null;

    // Get already booked times for the date
    let bookedTimes = [];
    if (date) {
      const queryDate = encodeURIComponent(`{Date} = '${date}'`);
      const res = await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}?filterByFormula=${queryDate}`, {
        headers: { Authorization: `Bearer ${AIRTABLE_API_KEY}` }
      });
      const data = await res.json();
      bookedTimes = data.records.map(r => r.fields["Time"]);
    }

    // Generate slots
    const start = 10, end = 20;
    for (let h = start; h < end; h++) {
      ["00", "30"].forEach(m => {
        const time = `${h.toString().padStart(2, "0")}:${m}`;
        const timeDisplay = new Date(`2024-01-01T${time}`).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });

        const div = document.createElement("div");
        div.className = "slot";
        div.textContent = timeDisplay;

        if (bookedTimes.includes(timeDisplay)) {
          div.style.opacity = 0.5;
          div.style.pointerEvents = "none";
          div.textContent += " âŒ";
        } else {
          div.onclick = () => {
            document.querySelectorAll(".slot").forEach(el => el.classList.remove("selected"));
            div.classList.add("selected");
            selectedSlot = timeDisplay;
          };
        }

        slotContainer.appendChild(div);
      });
    }
  }

  // Book the selected slot
  document.getElementById("bookBtn").onclick = async () => {
    const selectedDate = document.getElementById("date").value;
    if (!selectedDate || !selectedSlot) {
      alert("Please select both a date and time slot.");
      return;
    }

    const response = await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}`, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${AIRTABLE_API_KEY}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        fields: {
          "Client ID": sid,
          "Date": selectedDate,
          "Time": selectedSlot,
        },
      }),
    });

    if (response.ok) {
      document.getElementById("thankyouMessage").style.display = "block";
      await generateSlots(selectedDate); // Refresh slots
    } else {
      const data = await response.json();
      alert("Booking failed: " + (data?.error?.message || "Unknown error"));
    }
  };

  // Init blank
  generateSlots();
</script>
